{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file-upload/globalFileRestrictions.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUploadBase.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/proxy.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/requests.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/_configUploadStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/AmazonS3.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/FileSystem.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GoogleStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GridFS.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/Slingshot_DEPRECATED.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/sendFileMessage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/getS3FileUrl.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/AmazonS3/server.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/GoogleStorage/server.js"],"names":["filesize","module","watch","require","v","slingShotConfig","authorize","file","userId","Meteor","Error","RocketChat","fileUploadIsValidContentType","type","TAPi18n","__","maxFileSize","settings","get","size","maxSize","allowedFileTypes","Slingshot","fileRestrictions","FileUpload","validateFileUpload","Match","test","rid","String","user","room","models","Rooms","findOneById","directMessageAllow","fileUploadAllowed","authz","canAccessRoom","reason","language","t","parseInt","key","value","UploadFS","config","defaultStorePermissions","StorePermissions","insert","doc","message_id","indexOf","update","hasPermission","remove","FileUploadBase","store","meta","id","Random","getProgress","getFileName","name","start","callback","handler","Uploader","data","onError","err","onComplete","fileData","_","pick","url","replace","absoluteUrl","options","onProgress","progress","stop","export","FileUploadClass","fs","stream","mime","Future","Object","assign","handlers","configureUploadsStore","split","pop","stores","getStores","defaultUploads","collection","Uploads","model","filter","Filter","onCheck","getPath","_id","onValidate","uploadsOnValidate","defaultAvatars","Avatars","avatarsOnValidate","onFinishUpload","avatarsOnFinishUpload","avatarTransformWrite","readStream","writeStream","RocketChatFile","enabled","pipe","height","width","gm","background","resize","gravity","crop","extent","tmpFile","getTempFilePath","fut","setFormat","write","bindEnvironment","console","error","lstatSync","getCollection","direct","$set","return","wait","uploadsTransformWrite","fileId","undefined","identify","format","Orientation","includes","autoOrient","Users","oldAvatar","findOneByName","username","deleteFile","updateFileNameById","addExtensionTo","lookup","ext","extension","RegExp","getStore","modelName","storageType","handlerName","getStoreByName","req","res","next","writeHead","end","getModelFromName","_store","delete","deleteById","deleteByName","fileName","streamOrBuffer","cb","create","token","createToken","createWriteStream","Buffer","writeFileSync","call","e","http","URL","logger","Logger","WebApp","connectHandlers","stack","unshift","route","handle","storesPath","debug","method","parsedUrl","parse","path","pathname","substr","length","regExp","match","exec","findOne","instanceId","InstanceStatus","instance","extraInformation","host","process","env","INSTANCE_IP","isDocker","port","hostname","proxy","request","proxy_res","Cookies","protectedFiles","use","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","public","sandstorm","rawCookies","uid","cookie","headers","query","rc_uid","rc_token","findOneByIdAndLoginToken","setHeader","configStore","debounce","log","fileUrl","getRedirectURL","AmazonS3Uploads","AmazonS3Avatars","configure","Bucket","Acl","AWSAccessKeyId","AWSSecretAccessKey","URLExpiryTimeSpan","Region","SignatureVersion","ForcePathStyle","BucketURL","connection","accessKeyId","secretAccessKey","signatureVersion","s3ForcePathStyle","params","ACL","region","endpoint","FileSystemUploads","filePath","getFilePath","stat","wrapAsync","isFile","encodeURIComponent","uploadedAt","toUTCString","getReadStream","FileSystemAvatars","reqModifiedHeader","createFileSystemStore","GoogleCloudStorageUploads","GoogleCloudStorageAvatars","bucket","accessId","secret","credentials","client_email","private_key","zlib","util","ExtractRange","bytes_read","Transform","inherits","prototype","_transform","chunk","enc","newchunk","slice","push","getByteRange","header","matches","readFromGridFS","storeName","rs","ws","PassThrough","on","onReadError","emit","accept","transformRead","range","out_of_range","createGzip","createDeflate","onRead","collectionName","configureSlingshot","acl","accessKey","secretKey","cdn","bucketUrl","_directives","isEmpty","metaContext","upload","AmazonS3","insertFileInit","createDirective","S3Storage","message","createGoogleStorageDirective","GoogleAccessId","GoogleSecretKey","GoogleStorage","GoogleCloud","methods","roomId","msgData","check","avatar","Optional","emoji","alias","groupable","Boolean","msg","updateFileComplete","omit","attachment","title","description","title_link","title_link_download","image_url","image_type","image_size","image_dimensions","audio_url","audio_type","audio_size","video_url","video_type","video_size","ts","Date","attachments","defer","callbacks","run","getS3FileUrl","addGroup","add","i18nDescription","values","i18nLabel","section","enableQuery","multiline","AmazonS3Store","S3","extend","httpOptions","timeout","agent","classOptions","s3","Key","Expires","getSignedUrl","deleteObject","Range","getObject","createReadStream","getWriteStream","event","listener","nextTick","removeListener","putObject","Body","ContentType","Store","GoogleStorageStore","gcStorage","gcs","googleCloudStorage","action","responseDisposition","expires","now","gzip","metadata","contentType","contentDisposition"],"mappings":"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","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nimport filesize from 'filesize';\n\nconst slingShotConfig = {\n\tauthorize(file/*, metaContext*/) {\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-required', 'Please login before posting files');\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('error-invalid-file-type'));\n\t\t}\n\n\t\tconst maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: filesize(maxFileSize) }));\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n};\n\nSlingshot.fileRestrictions('rocketchat-uploads', slingShotConfig);\nSlingshot.fileRestrictions('rocketchat-uploads-gs', slingShotConfig);\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nimport filesize from 'filesize';\n\nlet maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (!Match.test(file.rid, String)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tconst room = RocketChat.models.Rooms.findOneById(file.rid);\n\t\tconst directMessageAllow = RocketChat.settings.get('FileUpload_Enabled_Direct');\n\t\tconst fileUploadAllowed = RocketChat.settings.get('FileUpload_Enabled');\n\n\t\tif (RocketChat.authz.canAccessRoom(room, user) !== true) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!fileUploadAllowed) {\n\t\t\tconst reason = TAPi18n.__('FileUpload_Disabled', user.language);\n\t\t\tthrow new Meteor.Error('error-file-upload-disabled', reason);\n\t\t}\n\n\t\tif (!directMessageAllow && room.t === 'd') {\n\t\t\tconst reason = TAPi18n.__('File_not_allowed_direct_messages', user.language);\n\t\t\tthrow new Meteor.Error('error-direct-message-file-upload-not-allowed', reason);\n\t\t}\n\n\t\tif (file.size > maxFileSize) {\n\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t}, user.language);\n\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t}\n\n\t\tif (parseInt(maxFileSize) > 0) {\n\t\t\tif (file.size > maxFileSize) {\n\t\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t\t}, user.language);\n\t\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t\t}\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tconst reason = TAPi18n.__('File_type_is_not_accepted', user.language);\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', reason);\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\tmaxFileSize = value;\n});\n","/* globals FileUploadBase:true, UploadFS */\n/* exported FileUploadBase */\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n\tinsert(userId, doc) {\n\t\treturn userId || (doc && doc.message_id && doc.message_id.indexOf('slack-') === 0); // allow inserts from slackbridge (message_id = slack-timestamp-milli)\n\t},\n\tupdate(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t},\n\tremove(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t}\n});\n\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(store, meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t\tthis.store = store;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart(callback) {\n\t\tthis.handler = new UploadFS.Uploader({\n\t\t\tstore: this.store,\n\t\t\tdata: this.file,\n\t\t\tfile: this.meta,\n\t\t\tonError: (err) => {\n\t\t\t\treturn callback(err);\n\t\t\t},\n\t\t\tonComplete: (fileData) => {\n\t\t\t\tconst file = _.pick(fileData, '_id', 'type', 'size', 'name', 'identify', 'description');\n\n\t\t\t\tfile.url = fileData.url.replace(Meteor.absoluteUrl(), '/');\n\t\t\t\treturn callback(null, file, this.store.options.name);\n\t\t\t}\n\t\t});\n\n\t\tthis.handler.onProgress = (file, progress) => {\n\t\t\tthis.onProgress(progress);\n\t\t};\n\n\t\treturn this.handler.start();\n\t}\n\n\tonProgress() {}\n\n\tstop() {\n\t\treturn this.handler.stop();\n\t}\n};\n","/* globals UploadFS */\n\nimport fs from 'fs';\nimport stream from 'stream';\nimport mime from 'mime-type/with-db';\nimport Future from 'fibers/future';\n\nObject.assign(FileUpload, {\n\thandlers: {},\n\n\tconfigureUploadsStore(store, name, options) {\n\t\tconst type = name.split(':').pop();\n\t\tconst stores = UploadFS.getStores();\n\t\tdelete stores[name];\n\n\t\treturn new UploadFS.store[store](Object.assign({\n\t\t\tname\n\t\t}, options, FileUpload[`default${ type }`]()));\n\t},\n\n\tdefaultUploads() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Uploads.model,\n\t\t\tfilter: new UploadFS.Filter({\n\t\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t\t}),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/uploads/${ file.rid }/${ file.userId }/${ file._id }`;\n\t\t\t},\n\t\t\t// transformWrite: FileUpload.uploadsTransformWrite\n\t\t\tonValidate: FileUpload.uploadsOnValidate\n\t\t};\n\t},\n\n\tdefaultAvatars() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Avatars.model,\n\t\t\t// filter: new UploadFS.Filter({\n\t\t\t// \tonCheck: FileUpload.validateFileUpload\n\t\t\t// }),\n\t\t\t// transformWrite: FileUpload.avatarTransformWrite,\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/avatars/${ file.userId }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.avatarsOnValidate,\n\t\t\tonFinishUpload: FileUpload.avatarsOnFinishUpload\n\t\t};\n\t},\n\n\tavatarTransformWrite(readStream, writeStream/*, fileId, file*/) {\n\t\tif (RocketChatFile.enabled === false || RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn readStream.pipe(writeStream);\n\t\t}\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst width = height;\n\t\treturn RocketChatFile.gm(readStream).background('#ffffff').resize(width, `${ height }^`).gravity('Center').crop(width, height).extent(width, height).stream('jpeg').pipe(writeStream);\n\t},\n\n\tavatarsOnValidate(file) {\n\t\tif (RocketChatFile.enabled === false || RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tmpFile = UploadFS.getTempFilePath(file._id);\n\n\t\tconst fut = new Future();\n\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst width = height;\n\n\t\tRocketChatFile.gm(tmpFile).background('#ffffff').resize(width, `${ height }^`).gravity('Center').crop(width, height).extent(width, height).setFormat('jpeg').write(tmpFile, Meteor.bindEnvironment((err) => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t}\n\n\t\t\tconst size = fs.lstatSync(tmpFile).size;\n\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\tfut.return();\n\t\t}));\n\n\t\treturn fut.wait();\n\t},\n\n\tuploadsTransformWrite(readStream, writeStream, fileId, file) {\n\t\tif (RocketChatFile.enabled === false || !/^image\\/.+/.test(file.type)) {\n\t\t\treturn readStream.pipe(writeStream);\n\t\t}\n\n\t\tlet stream = undefined;\n\n\t\tconst identify = function(err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t}\n\n\t\t\tfile.identify = {\n\t\t\t\tformat: data.format,\n\t\t\t\tsize: data.size\n\t\t\t};\n\n\t\t\tif (data.Orientation && !['', 'Unknown', 'Undefined'].includes(data.Orientation)) {\n\t\t\t\tRocketChatFile.gm(stream).autoOrient().stream().pipe(writeStream);\n\t\t\t} else {\n\t\t\t\tstream.pipe(writeStream);\n\t\t\t}\n\t\t};\n\n\t\tstream = RocketChatFile.gm(readStream).identify(identify).stream();\n\t},\n\n\tuploadsOnValidate(file) {\n\t\tif (RocketChatFile.enabled === false || !/^image\\/((x-windows-)?bmp|p?jpeg|png)$/.test(file.type)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tmpFile = UploadFS.getTempFilePath(file._id);\n\n\t\tconst fut = new Future();\n\n\t\tconst identify = Meteor.bindEnvironment((err, data) => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tfile.identify = {\n\t\t\t\tformat: data.format,\n\t\t\t\tsize: data.size\n\t\t\t};\n\n\t\t\tif ([null, undefined, '', 'Unknown', 'Undefined'].includes(data.Orientation)) {\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tRocketChatFile.gm(tmpFile).autoOrient().write(tmpFile, Meteor.bindEnvironment((err) => {\n\t\t\t\tif (err != null) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tconst size = fs.lstatSync(tmpFile).size;\n\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\t\tfut.return();\n\t\t\t}));\n\t\t});\n\n\t\tRocketChatFile.gm(tmpFile).identify(identify);\n\n\t\treturn fut.wait();\n\t},\n\n\tavatarsOnFinishUpload(file) {\n\t\t// update file record to match user's username\n\t\tconst user = RocketChat.models.Users.findOneById(file.userId);\n\t\tconst oldAvatar = RocketChat.models.Avatars.findOneByName(user.username);\n\t\tif (oldAvatar) {\n\t\t\tRocketChat.models.Avatars.deleteFile(oldAvatar._id);\n\t\t}\n\t\tRocketChat.models.Avatars.updateFileNameById(file._id, user.username);\n\t\t// console.log('upload finished ->', file);\n\t},\n\n\taddExtensionTo(file) {\n\t\tif (mime.lookup(file.name) === file.type) {\n\t\t\treturn file;\n\t\t}\n\n\t\tconst ext = mime.extension(file.type);\n\t\tif (ext && false === new RegExp(`\\.${ ext }$`, 'i').test(file.name)) {\n\t\t\tfile.name = `${ file.name }.${ ext }`;\n\t\t}\n\n\t\treturn file;\n\t},\n\n\tgetStore(modelName) {\n\t\tconst storageType = RocketChat.settings.get('FileUpload_Storage_Type');\n\t\tconst handlerName = `${ storageType }:${ modelName }`;\n\n\t\treturn this.getStoreByName(handlerName);\n\t},\n\n\tgetStoreByName(handlerName) {\n\t\tif (this.handlers[handlerName] == null) {\n\t\t\tconsole.error(`Upload handler \"${ handlerName }\" does not exists`);\n\t\t}\n\n\t\treturn this.handlers[handlerName];\n\t},\n\n\tget(file, req, res, next) {\n\t\tif (file.store && this.handlers && this.handlers[file.store] && this.handlers[file.store].get) {\n\t\t\tthis.handlers[file.store].get(file, req, res, next);\n\t\t} else {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\n\nexport class FileUploadClass {\n\tconstructor({ name, model, store, get, insert, getStore }) {\n\t\tthis.name = name;\n\t\tthis.model = model || this.getModelFromName();\n\t\tthis._store = store || UploadFS.getStore(name);\n\t\tthis.get = get;\n\n\t\tif (insert) {\n\t\t\tthis.insert = insert;\n\t\t}\n\n\t\tif (getStore) {\n\t\t\tthis.getStore = getStore;\n\t\t}\n\n\t\tFileUpload.handlers[name] = this;\n\t}\n\n\tgetStore() {\n\t\treturn this._store;\n\t}\n\n\tget store() {\n\t\treturn this.getStore();\n\t}\n\n\tset store(store) {\n\t\tthis._store = store;\n\t}\n\n\tgetModelFromName() {\n\t\treturn RocketChat.models[this.name.split(':')[1]];\n\t}\n\n\tdelete(fileId) {\n\t\tif (this.store && this.store.delete) {\n\t\t\tthis.store.delete(fileId);\n\t\t}\n\n\t\treturn this.model.deleteFile(fileId);\n\t}\n\n\tdeleteById(fileId) {\n\t\tconst file = this.model.findOneById(fileId);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tdeleteByName(fileName) {\n\t\tconst file = this.model.findOneByName(fileName);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tinsert(fileData, streamOrBuffer, cb) {\n\t\tconst fileId = this.store.create(fileData);\n\t\tconst token = this.store.createToken(fileId);\n\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\t\ttry {\n\t\t\tif (streamOrBuffer instanceof stream) {\n\t\t\t\tstreamOrBuffer.pipe(fs.createWriteStream(tmpFile));\n\t\t\t} else if (streamOrBuffer instanceof Buffer) {\n\t\t\t\tfs.writeFileSync(tmpFile, streamOrBuffer);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid file type');\n\t\t\t}\n\n\t\t\tconst file = Meteor.call('ufsComplete', fileId, this.name, token);\n\n\t\t\tif (cb) {\n\t\t\t\tcb(null, file);\n\t\t\t}\n\n\t\t\treturn file;\n\t\t} catch (e) {\n\t\t\tif (cb) {\n\t\t\t\tcb(e);\n\t\t\t} else {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n}\n","/* globals UploadFS, InstanceStatus */\n\nimport http from 'http';\nimport URL from 'url';\n\nconst logger = new Logger('UploadProxy');\n\nWebApp.connectHandlers.stack.unshift({\n\troute: '',\n\thandle: Meteor.bindEnvironment(function(req, res, next) {\n\t\t// Quick check to see if request should be catch\n\t\tif (req.url.indexOf(UploadFS.config.storesPath) === -1) {\n\t\t\treturn next();\n\t\t}\n\n\t\tlogger.debug('Upload URL:', req.url);\n\n\t\tif (req.method !== 'POST') {\n\t\t\treturn next();\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\t// Get store\n\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get file\n\t\tconst fileId = match[2];\n\t\tconst file = store.getCollection().findOne({_id: fileId});\n\t\tif (file === undefined) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (file.instanceId === InstanceStatus.id()) {\n\t\t\tlogger.debug('Correct instance');\n\t\t\treturn next();\n\t\t}\n\n\t\t// Proxy to other instance\n\t\tconst instance = InstanceStatus.getCollection().findOne({_id: file.instanceId});\n\n\t\tif (instance == null) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (instance.extraInformation.host === process.env.INSTANCE_IP && RocketChat.isDocker() === false) {\n\t\t\tinstance.extraInformation.host = 'localhost';\n\t\t}\n\n\t\tlogger.debug('Wrong instance, proxing to:', `${ instance.extraInformation.host }:${ instance.extraInformation.port }`);\n\n\t\tconst options = {\n\t\t\thostname: instance.extraInformation.host,\n\t\t\tport: instance.extraInformation.port,\n\t\t\tpath: req.url,\n\t\t\tmethod: 'POST'\n\t\t};\n\n\t\tconst proxy = http.request(options, function(proxy_res) {\n\t\t\tproxy_res.pipe(res, {\n\t\t\t\tend: true\n\t\t\t});\n\t\t});\n\n\t\treq.pipe(proxy, {\n\t\t\tend: true\n\t\t});\n\t})\n});\n","/* globals FileUpload, WebApp */\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nWebApp.connectHandlers.use(`${ __meteor_runtime_config__.ROOT_URL_PATH_PREFIX }/file-upload/`,\tfunction(req, res, next) {\n\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst file = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (!Meteor.settings.public.sandstorm && protectedFiles) {\n\t\t\t\tlet rawCookies;\n\t\t\t\tlet token;\n\t\t\t\tlet uid;\n\t\t\t\tconst cookie = new Cookies();\n\n\t\t\t\tif (req.headers && req.headers.cookie != null) {\n\t\t\t\t\trawCookies = req.headers.cookie;\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\tuid = cookie.get('rc_uid', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\ttoken = cookie.get('rc_token', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (uid == null) {\n\t\t\t\t\tuid = req.query.rc_uid;\n\t\t\t\t\ttoken = req.query.rc_token;\n\t\t\t\t}\n\n\t\t\t\tif (!(uid && token && RocketChat.models.Users.findOneByIdAndLoginToken(uid, token))) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tres.setHeader('Content-Security-Policy', 'default-src \\'none\\'');\n\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n\treturn;\n});\n","/* globals UploadFS */\n\nimport './AmazonS3.js';\nimport './FileSystem.js';\nimport './GoogleStorage.js';\nimport './GridFS.js';\nimport './Slingshot_DEPRECATED.js';\n\nconst configStore = _.debounce(() => {\n\tconst store = RocketChat.settings.get('FileUpload_Storage_Type');\n\n\tif (store) {\n\t\tconsole.log('Setting default file store to', store);\n\t\tUploadFS.getStores().Avatars = UploadFS.getStore(`${ store }:Avatars`);\n\t\tUploadFS.getStores().Uploads = UploadFS.getStore(`${ store }:Uploads`);\n\t}\n}, 1000);\n\nRocketChat.settings.get(/^FileUpload_/, configStore);\n","/* globals FileUpload */\n\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/AmazonS3/server.js';\n\nconst get = function(file, req, res) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tres.setHeader('Location', fileUrl);\n\t\tres.writeHead(302);\n\t}\n\tres.end();\n};\n\nconst AmazonS3Uploads = new FileUploadClass({\n\tname: 'AmazonS3:Uploads',\n\tget\n\t// store setted bellow\n});\n\nconst AmazonS3Avatars = new FileUploadClass({\n\tname: 'AmazonS3:Avatars',\n\tget\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst Bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst Acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst AWSAccessKeyId = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst AWSSecretAccessKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\tconst Region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst SignatureVersion = RocketChat.settings.get('FileUpload_S3_SignatureVersion');\n\tconst ForcePathStyle = RocketChat.settings.get('FileUpload_S3_ForcePathStyle');\n\t// const CDN = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst BucketURL = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tif (!Bucket || !AWSAccessKeyId || !AWSSecretAccessKey) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\taccessKeyId: AWSAccessKeyId,\n\t\t\tsecretAccessKey: AWSSecretAccessKey,\n\t\t\tsignatureVersion: SignatureVersion,\n\t\t\ts3ForcePathStyle: ForcePathStyle,\n\t\t\tparams: {\n\t\t\t\tBucket,\n\t\t\t\tACL: Acl\n\t\t\t},\n\t\t\tregion: Region\n\t\t},\n\t\tURLExpiryTimeSpan\n\t};\n\n\tif (BucketURL) {\n\t\tconfig.connection.endpoint = BucketURL;\n\t}\n\n\tAmazonS3Uploads.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Uploads.name, config);\n\tAmazonS3Avatars.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Avatars.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_S3_/, configure);\n","/* globals FileUpload, UploadFS */\n\nimport fs from 'fs';\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader) {\n\t\t\tif (reqModifiedHeader === (file.uploadedAt && file.uploadedAt.toUTCString())) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', 'inline');\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\n\nconst createFileSystemStore = _.debounce(function() {\n\tconst options = {\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath') //'/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\n\t// DEPRECATED backwards compatibililty (remove)\n\tUploadFS.getStores()['fileSystem'] = UploadFS.getStores()[FileSystemUploads.name];\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n","/* globals FileUpload */\n\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server.js';\n\n\nconst get = function(file, req, res) {\n\tthis.store.getRedirectURL(file, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t}\n\n\t\tif (fileUrl) {\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t}\n\t\tres.end();\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret\n\t\t\t}\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, configure);\n","/* globals FileUpload, UploadFS */\nimport stream from 'stream';\nimport zlib from 'zlib';\nimport util from 'util';\n\nimport { FileUploadClass } from '../lib/FileUpload';\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nconst cookie = new Cookies();\n\nconst logger = new Logger('FileUpload');\n\nfunction ExtractRange(options) {\n\tif (!(this instanceof ExtractRange)) {\n\t\treturn new ExtractRange(options);\n\t}\n\n\tthis.start = options.start;\n\tthis.stop = options.stop;\n\tthis.bytes_read = 0;\n\n\tstream.Transform.call(this, options);\n}\nutil.inherits(ExtractRange, stream.Transform);\n\n\nExtractRange.prototype._transform = function(chunk, enc, cb) {\n\tif (this.bytes_read > this.stop) {\n\t\t// done reading\n\t\tthis.end();\n\t} else if (this.bytes_read + chunk.length < this.start) {\n\t\t// this chunk is still before the start byte\n\t} else {\n\t\tlet start;\n\t\tlet stop;\n\n\t\tif (this.start <= this.bytes_read) {\n\t\t\tstart = 0;\n\t\t} else {\n\t\t\tstart = this.start - this.bytes_read;\n\t\t}\n\t\tif ((this.stop - this.bytes_read + 1) < chunk.length) {\n\t\t\tstop = this.stop - this.bytes_read + 1;\n\t\t} else {\n\t\t\tstop = chunk.length;\n\t\t}\n\t\tconst newchunk = chunk.slice(start, stop);\n\t\tthis.push(newchunk);\n\t}\n\tthis.bytes_read += chunk.length;\n\tcb();\n};\n\n\nconst getByteRange = function(header) {\n\tif (header) {\n\t\tconst matches = header.match(/(\\d+)-(\\d+)/);\n\t\tif (matches) {\n\t\t\treturn {\n\t\t\t\tstart: parseInt(matches[1], 10),\n\t\t\t\tstop: parseInt(matches[2], 10)\n\t\t\t};\n\t\t}\n\t}\n\treturn null;\n};\n\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L91\nconst readFromGridFS = function(storeName, fileId, file, headers, req, res) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\tconst ws = new stream.PassThrough();\n\n\trs.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t});\n\tws.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t});\n\tws.on('close', function() {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tconst accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\tconst range = getByteRange(req.headers.range);\n\tlet out_of_range = false;\n\tif (range) {\n\t\tout_of_range = (range.start > file.size) || (range.stop <= range.start) || (range.stop > file.size);\n\t}\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/) && range === null) {\n\t\theaders['Content-Encoding'] = 'gzip';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t} else if (accept.match(/\\bdeflate\\b/) && range === null) {\n\t\t// Compress data using deflate\n\t\theaders['Content-Encoding'] = 'deflate';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t} else if (range && out_of_range) {\n\t\t// out of range request, return 416\n\t\tdelete headers['Content-Length'];\n\t\tdelete headers['Content-Type'];\n\t\tdelete headers['Content-Disposition'];\n\t\tdelete headers['Last-Modified'];\n\t\theaders['Content-Range'] = `bytes */${ file.size }`;\n\t\tres.writeHead(416, headers);\n\t\tres.end();\n\t} else if (range) {\n\t\theaders['Content-Range'] = `bytes ${ range.start }-${ range.stop }/${ file.size }`;\n\t\tdelete headers['Content-Length'];\n\t\theaders['Content-Length'] = range.stop - range.start + 1;\n\t\tres.writeHead(206, headers);\n\t\tlogger.debug('File upload extracting range');\n\t\tws.pipe(new ExtractRange({ start: range.start, stop: range.stop })).pipe(res);\n\t} else {\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(res);\n\t}\n};\n\nconst onRead = function(fileId, file, req, res) {\n\tif (RocketChat.settings.get('FileUpload_ProtectFiles')) {\n\t\tlet uid;\n\t\tlet token;\n\n\t\tif (req && req.headers && req.headers.cookie) {\n\t\t\tconst rawCookies = req.headers.cookie;\n\n\t\t\tif (rawCookies) {\n\t\t\t\tuid = cookie.get('rc_uid', rawCookies) ;\n\t\t\t\ttoken = cookie.get('rc_token', rawCookies);\n\t\t\t}\n\t\t}\n\n\t\tif (!uid) {\n\t\t\tuid = req.query.rc_uid;\n\t\t\ttoken = req.query.rc_token;\n\t\t}\n\n\t\tif (!uid || !token || !RocketChat.models.Users.findOneByIdAndLoginToken(uid, token)) {\n\t\t\tres.writeHead(403);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tres.setHeader('content-disposition', `attachment; filename=\"${ encodeURIComponent(file.name) }\"`);\n\treturn true;\n};\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Uploads', {\n\tcollectionName: 'rocketchat_uploads',\n\tonRead\n});\n\n// DEPRECATED: backwards compatibility (remove)\nUploadFS.getStores()['rocketchat_uploads'] = UploadFS.getStores()['GridFS:Uploads'];\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Avatars', {\n\tcollectionName: 'rocketchat_avatars',\n\tonRead\n});\n\n\nnew FileUploadClass({\n\tname: 'GridFS:Uploads',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst headers = {\n\t\t\t'Content-Disposition': `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`,\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t}\n});\n\nnew FileUploadClass({\n\tname: 'GridFS:Avatars',\n\n\tget(file, req, res) {\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader) {\n\t\t\tif (reqModifiedHeader === (file.uploadedAt && file.uploadedAt.toUTCString())) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst headers = {\n\t\t\t'Cache-Control': 'public, max-age=0',\n\t\t\t'Expires': '-1',\n\t\t\t'Content-Disposition': 'inline',\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t}\n});\n","/* globals Slingshot, FileUpload */\n\nconst configureSlingshot = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tdelete Slingshot._directives['rocketchat-uploads'];\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives['rocketchat-uploads']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads'];\n\t\t}\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tAmazonS3: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'AmazonS3:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t},\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads', Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring S3 ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', configureSlingshot);\nRocketChat.settings.get(/^FileUpload_S3_/, configureSlingshot);\n\n\n\nconst createGoogleStorageDirective = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\n\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\n\tif (type === 'GoogleCloudStorage' && !_.isEmpty(secret) && !_.isEmpty(accessId) && !_.isEmpty(bucket)) {\n\t\tif (Slingshot._directives['rocketchat-uploads-gs']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\t\t}\n\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tGoogleAccessId: accessId,\n\t\t\tGoogleSecretKey: secret,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tGoogleStorage: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'GoogleCloudStorage:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads-gs', Slingshot.GoogleCloud, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring GoogleCloudStorage ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createGoogleStorageDirective);\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, createGoogleStorageDirective);\n","Meteor.methods({\n\t'sendFileMessage'(roomId, store, file, msgData = {}) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String)\n\t\t});\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tconst fileUrl = `/file-upload/${ file._id }/${ file.name }`;\n\n\t\tconst attachment = {\n\t\t\ttitle: file.name,\n\t\t\ttype: 'file',\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tlet msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name,\n\t\t\t\ttype: file.type\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t}, msgData);\n\n\t\tmsg = Meteor.call('sendMessage', msg);\n\n\t\tMeteor.defer(() => RocketChat.callbacks.run('afterFileUpload', { user, room, message: msg }));\n\n\t\treturn msg;\n\t}\n});\n","/* globals UploadFS */\n\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nMeteor.methods({\n\tgetS3FileUrl(fileId) {\n\t\tif (protectedFiles && !Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\n\t\treturn UploadFS.getStore('AmazonS3:Uploads').getRedirectURL(file);\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,video/*,application/zip,application/x-rar-compressed,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'GoogleCloudStorage',\n\t\t\ti18nLabel: 'GoogleCloudStorage'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t\tthis.add('FileUpload_S3_SignatureVersion', 'v4', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_ForcePathStyle', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_URLExpiryTimeSpan', 120, {\n\t\t\ttype: 'int',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'FileUpload_S3_URLExpiryTimeSpan_Description'\n\t\t});\n\t});\n\n\tthis.section('Google Cloud Storage', function() {\n\t\tthis.add('FileUpload_GoogleStorage_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_AccessId', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Secret', '', {\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.add('FileUpload_Enabled_Direct', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n});\n","import {_} from 'meteor/underscore';\nimport {UploadFS} from 'meteor/jalik:ufs';\nimport S3 from 'aws-sdk/clients/s3';\nimport stream from 'stream';\n\n/**\n * AmazonS3 store\n * @param options\n * @constructor\n */\nexport class AmazonS3Store extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\t// Default options\n\t\t// options.secretAccessKey,\n\t\t// options.accessKeyId,\n\t\t// options.region,\n\t\t// options.sslEnabled // optional\n\n\t\toptions = _.extend({\n\t\t\thttpOptions: {\n\t\t\t\ttimeout: 6000,\n\t\t\t\tagent: false\n\t\t\t}\n\t\t}, options);\n\n\t\tsuper(options);\n\n\t\tconst classOptions = options;\n\n\t\tconst s3 = new S3(options.connection);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.AmazonS3) {\n\t\t\t\treturn file.AmazonS3.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.s3) {\n\t\t\t\treturn file.s3.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tExpires: classOptions.URLExpiryTimeSpan\n\t\t\t};\n\n\t\t\treturn s3.getSignedUrl('getObject', params);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.AmazonS3 = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\ts3.deleteObject(params, (err, data) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\tif (options.start && options.end) {\n\t\t\t\tparams.Range = `${ options.start } - ${ options.end }`;\n\t\t\t}\n\n\t\t\treturn s3.getObject(params).createReadStream();\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\tconst writeStream = new stream.PassThrough();\n\t\t\twriteStream.length = file.size;\n\n\t\t\twriteStream.on('newListener', (event, listener) => {\n\t\t\t\tif (event === 'finish') {\n\t\t\t\t\tprocess.nextTick(() => {\n\t\t\t\t\t\twriteStream.removeListener(event, listener);\n\t\t\t\t\t\twriteStream.on('real_finish', listener);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ts3.putObject({\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tBody: writeStream,\n\t\t\t\tContentType: file.type\n\n\t\t\t}, (error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\tconsole.error(error);\n\t\t\t\t}\n\n\t\t\t\twriteStream.emit('real_finish');\n\t\t\t});\n\n\t\t\treturn writeStream;\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.AmazonS3 = AmazonS3Store;\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport gcStorage from '@google-cloud/storage';\n\n/**\n * GoogleStorage store\n * @param options\n * @constructor\n */\nexport class GoogleStorageStore extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\tsuper(options);\n\n\t\tconst gcs = gcStorage(options.connection);\n\t\tthis.bucket = gcs.bucket(options.bucket);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.GoogleStorage) {\n\t\t\t\treturn file.GoogleStorage.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.googleCloudStorage) {\n\t\t\t\treturn file.googleCloudStorage.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file, callback) {\n\t\t\tconst params = {\n\t\t\t\taction: 'read',\n\t\t\t\tresponseDisposition: 'inline',\n\t\t\t\texpires: Date.now()+this.options.URLExpiryTimeSpan*1000\n\t\t\t};\n\n\t\t\tthis.bucket.file(this.getPath(file)).getSignedUrl(params, callback);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.GoogleStorage = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tthis.bucket.file(this.getPath(file)).delete(function(err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst config = {};\n\n\t\t\tif (options.start != null) {\n\t\t\t\tconfig.start = options.start;\n\t\t\t}\n\n\t\t\tif (options.end != null) {\n\t\t\t\tconfig.end = options.end;\n\t\t\t}\n\n\t\t\treturn this.bucket.file(this.getPath(file)).createReadStream(config);\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\treturn this.bucket.file(this.getPath(file)).createWriteStream({\n\t\t\t\tgzip: false,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcontentType: file.type,\n\t\t\t\t\tcontentDisposition: `inline; filename=${ file.name }`\n\t\t\t\t\t// metadata: {\n\t\t\t\t\t// \tcustom: 'metadata'\n\t\t\t\t\t// }\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.GoogleStorage = GoogleStorageStore;\n"]}