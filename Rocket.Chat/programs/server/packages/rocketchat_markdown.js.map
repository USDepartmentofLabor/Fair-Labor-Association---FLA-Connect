{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:markdown/settings.js","meteor://ðŸ’»app/packages/rocketchat:markdown/markdown.js","meteor://ðŸ’»app/packages/rocketchat:markdown/markdowncode.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","section","i18nDescription","MarkdownClass","parse","text","parseNotEscaped","_","escapeHTML","msg","message","tokens","schemes","get","split","join","replace","RegExp","match","title","url","target","indexOf","absoluteUrl","html","token","Random","id","push","window","rocketDebug","undefined","console","log","Markdown","MarkdownMessage","trim","callbacks","priority","HIGH","isClient","Blaze","registerHelper","hljs","module","watch","require","v","MarkdownCode","s","handle_codeblocks","handle_inlinecode","p1","p2","p3","noHtml","count","length","msgParts","index","part","codeMatch","singleLine","lang","Array","from","listLanguages","includes","code","unescapeHTML","result","highlightAuto","highlight","language","value","stripTags","MarkdownCodeCB"],"mappings":"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","file":"/packages/rocketchat_markdown.js","sourcesContent":["Meteor.startup(() => {\n\tRocketChat.settings.add('Markdown_Headers', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Message',\n\t\tsection: 'Markdown',\n\t\tpublic: true\n\t});\n\n\treturn RocketChat.settings.add('Markdown_SupportSchemesForLink', 'http,https', {\n\t\ttype: 'string',\n\t\tgroup: 'Message',\n\t\tsection: 'Markdown',\n\t\tpublic: true,\n\t\ti18nDescription: 'Markdown_SupportSchemesForLink_Description'\n\t});\n});\n","/*\n * Markdown is a named function that will parse markdown syntax\n * @param {Object} message - The message object\n */\n\nclass MarkdownClass {\n\tparse(text) {\n\t\treturn this.parseNotEscaped(_.escapeHTML(text));\n\t}\n\n\tparseNotEscaped(msg, message) {\n\t\tif (message && message.tokens == null) {\n\t\t\tmessage.tokens = [];\n\t\t}\n\n\t\tconst schemes = RocketChat.settings.get('Markdown_SupportSchemesForLink').split(',').join('|');\n\n\t\tif (RocketChat.settings.get('Markdown_Headers')) {\n\t\t\t// Support # Text for h1\n\t\t\tmsg = msg.replace(/^# (([\\S\\w\\d-_\\/\\*\\.,\\\\][ \\u00a0\\u1680\\u180e\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]?)+)/gm, '<h1>$1</h1>');\n\n\t\t\t// Support # Text for h2\n\t\t\tmsg = msg.replace(/^## (([\\S\\w\\d-_\\/\\*\\.,\\\\][ \\u00a0\\u1680\\u180e\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]?)+)/gm, '<h2>$1</h2>');\n\n\t\t\t// Support # Text for h3\n\t\t\tmsg = msg.replace(/^### (([\\S\\w\\d-_\\/\\*\\.,\\\\][ \\u00a0\\u1680\\u180e\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]?)+)/gm, '<h3>$1</h3>');\n\n\t\t\t// Support # Text for h4\n\t\t\tmsg = msg.replace(/^#### (([\\S\\w\\d-_\\/\\*\\.,\\\\][ \\u00a0\\u1680\\u180e\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]?)+)/gm, '<h4>$1</h4>');\n\t\t}\n\n\t\t// Support *text* to make bold\n\t\tmsg = msg.replace(/(^|&gt;|[ >_~`])\\*{1,2}([^\\*\\r\\n]+)\\*{1,2}([<_~`]|\\B|\\b|$)/gm, '$1<span class=\"copyonly\">*</span><strong>$2</strong><span class=\"copyonly\">*</span>$3');\n\n\t\t// Support _text_ to make italics\n\t\tmsg = msg.replace(/(^|&gt;|[ >*~`])\\_([^\\_\\r\\n]+)\\_([<*~`]|\\B|\\b|$)/gm, '$1<span class=\"copyonly\">_</span><em>$2</em><span class=\"copyonly\">_</span>$3');\n\n\t\t// Support ~text~ to strike through text\n\t\tmsg = msg.replace(/(^|&gt;|[ >_*`])\\~{1,2}([^~\\r\\n]+)\\~{1,2}([<_*`]|\\B|\\b|$)/gm, '$1<span class=\"copyonly\">~</span><strike>$2</strike><span class=\"copyonly\">~</span>$3');\n\n\t\t// Support for block quote\n\t\t// >>>\n\t\t// Text\n\t\t// <<<\n\t\tmsg = msg.replace(/(?:&gt;){3}\\n+([\\s\\S]*?)\\n+(?:&lt;){3}/g, '<blockquote class=\"background-transparent-darker-before\"><span class=\"copyonly\">&gt;&gt;&gt;</span>$1<span class=\"copyonly\">&lt;&lt;&lt;</span></blockquote>');\n\n\t\t// Support >Text for quote\n\t\tmsg = msg.replace(/^&gt;(.*)$/gm, '<blockquote class=\"background-transparent-darker-before\"><span class=\"copyonly\">&gt;</span>$1</blockquote>');\n\n\t\t// Remove white-space around blockquote (prevent <br>). Because blockquote is block element.\n\t\tmsg = msg.replace(/\\s*<blockquote class=\"background-transparent-darker-before\">/gm, '<blockquote class=\"background-transparent-darker-before\">');\n\t\tmsg = msg.replace(/<\\/blockquote>\\s*/gm, '</blockquote>');\n\n\t\t// Remove new-line between blockquotes.\n\t\tmsg = msg.replace(/<\\/blockquote>\\n<blockquote/gm, '</blockquote><blockquote');\n\n\t\t// Support ![alt text](http://image url)\n\t\tmsg = msg.replace(new RegExp(`!\\\\[([^\\\\]]+)\\\\]\\\\(((?:${ schemes }):\\\\/\\\\/[^\\\\)]+)\\\\)`, 'gm'), function(match, title, url) {\n\t\t\tconst target = url.indexOf(Meteor.absoluteUrl()) === 0 ? '' : '_blank';\n\t\t\tconst html = `<a href=\"${ _.escapeHTML(url) }\" title=\"${ _.escapeHTML(title) }\" target=\"${ _.escapeHTML(target) }\" rel=\"noopener noreferrer\"><div class=\"inline-image\" style=\"background-image: url(${ _.escapeHTML(url) });\"></div></a>`;\n\n\t\t\tif (message && message.tokens) {\n\t\t\t\tconst token = `=!=${ Random.id() }=!=`;\n\n\t\t\t\tmessage.tokens.push({\n\t\t\t\t\ttoken,\n\t\t\t\t\ttext: html\n\t\t\t\t});\n\n\t\t\t\treturn token;\n\t\t\t}\n\n\t\t\treturn html;\n\t\t});\n\n\t\t// Support [Text](http://link)\n\t\tmsg = msg.replace(new RegExp(`\\\\[([^\\\\]]+)\\\\]\\\\(((?:${ schemes }):\\\\/\\\\/[^\\\\)]+)\\\\)`, 'gm'), function(match, title, url) {\n\t\t\tconst target = url.indexOf(Meteor.absoluteUrl()) === 0 ? '' : '_blank';\n\t\t\treturn `<a href=\"${ _.escapeHTML(url) }\" target=\"${ _.escapeHTML(target) }\" rel=\"noopener noreferrer\">${ _.escapeHTML(title) }</a>`;\n\t\t});\n\n\t\t// Support <http://link|Text>\n\t\tmsg = msg.replace(new RegExp(`(?:<|&lt;)((?:${ schemes }):\\\\/\\\\/[^\\\\|]+)\\\\|(.+?)(?=>|&gt;)(?:>|&gt;)`, 'gm'), (match, url, title) => {\n\t\t\tconst target = url.indexOf(Meteor.absoluteUrl()) === 0 ? '' : '_blank';\n\t\t\treturn `<a href=\"${ _.escapeHTML(url) }\" target=\"${ _.escapeHTML(target) }\" rel=\"noopener noreferrer\">${ _.escapeHTML(title) }</a>`;\n\t\t});\n\n\t\tif (typeof window !== 'undefined' && window !== null ? window.rocketDebug : undefined) { console.log('Markdown', msg); }\n\n\t\treturn msg;\n\t}\n}\n\nconst Markdown = new MarkdownClass;\nRocketChat.Markdown = Markdown;\n\n// renderMessage already did html escape\nconst MarkdownMessage = (message) => {\n\tif (_.trim(message != null ? message.html : undefined)) {\n\t\tmessage.html = Markdown.parseNotEscaped(message.html, message);\n\t}\n\n\treturn message;\n};\n\nRocketChat.callbacks.add('renderMessage', MarkdownMessage, RocketChat.callbacks.priority.HIGH, 'markdown');\n\nif (Meteor.isClient) {\n\tBlaze.registerHelper('RocketChatMarkdown', text => Markdown.parse(text));\n\tBlaze.registerHelper('RocketChatMarkdownUnescape', text => Markdown.parseNotEscaped(text));\n}\n","/*\n * MarkdownCode is a named function that will parse `inline code` and ```codeblock``` syntaxes\n * @param {Object} message - The message object\n */\nimport hljs from 'highlight.js';\n\nclass MarkdownCode {\n\tconstructor(message) {\n\n\t\tif (s.trim(message.html)) {\n\t\t\tif (message.tokens == null) {\n\t\t\t\tmessage.tokens = [];\n\t\t\t}\n\n\t\t\tMarkdownCode.handle_codeblocks(message);\n\t\t\tMarkdownCode.handle_inlinecode(message);\n\n\t\t\tif (window && window.rocketDebug) {\n\t\t\t\tconsole.log('Markdown', message);\n\t\t\t}\n\t\t}\n\n\t\treturn message;\n\t}\n\n\tstatic handle_inlinecode(message) {\n\t\t// Support `text`\n\t\treturn message.html = message.html.replace(/(^|&gt;|[ >_*~])\\`([^`\\r\\n]+)\\`([<_*~]|\\B|\\b|$)/gm, (match, p1, p2, p3) => {\n\t\t\tconst token = `=!=${ Random.id() }=!=`;\n\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken,\n\t\t\t\ttext: `${ p1 }<span class=\\\"copyonly\\\">\\`</span><span><code class=\\\"code-colors inline\\\">${ p2 }</code></span><span class=\\\"copyonly\\\">\\`</span>${ p3 }`,\n\t\t\t\tnoHtml: match\n\t\t\t});\n\n\t\t\treturn token;\n\t\t});\n\t}\n\n\tstatic handle_codeblocks(message) {\n\t\t// Count occurencies of ```\n\t\tconst count = (message.html.match(/```/g) || []).length;\n\n\t\tif (count) {\n\n\t\t\t// Check if we need to add a final ```\n\t\t\tif ((count % 2) > 0) {\n\t\t\t\tmessage.html = `${ message.html }\\n\\`\\`\\``;\n\t\t\t\tmessage.msg = `${ message.msg }\\n\\`\\`\\``;\n\t\t\t}\n\n\t\t\t// Separate text in code blocks and non code blocks\n\t\t\tconst msgParts = message.html.split(/(^.*)(```(?:[a-zA-Z]+)?(?:(?:.|\\r|\\n)*?)```)(.*\\n?)$/gm);\n\n\t\t\tfor (let index = 0; index < msgParts.length; index++) {\n\t\t\t\t// Verify if this part is code\n\t\t\t\tconst part = msgParts[index];\n\t\t\t\tconst codeMatch = part.match(/^```(.*[\\r\\n\\ ]?)([\\s\\S]*?)```+?$/);\n\n\t\t\t\tif (codeMatch != null) {\n\t\t\t\t\t// Process highlight if this part is code\n\t\t\t\t\tconst singleLine = codeMatch[0].indexOf('\\n') === -1;\n\t\t\t\t\tconst lang = !singleLine && Array.from(hljs.listLanguages()).includes(s.trim(codeMatch[1])) ? s.trim(codeMatch[1]) : '';\n\t\t\t\t\tconst code =\n\t\t\t\t\t\tsingleLine ?\n\t\t\t\t\t\t\t_.unescapeHTML(codeMatch[1]) :\n\t\t\t\t\t\t\tlang === '' ?\n\t\t\t\t\t\t\t\t_.unescapeHTML(codeMatch[1] + codeMatch[2]) :\n\t\t\t\t\t\t\t\t_.unescapeHTML(codeMatch[2]);\n\n\t\t\t\t\tconst result = lang === '' ? hljs.highlightAuto((lang + code)) : hljs.highlight(lang, code);\n\t\t\t\t\tconst token = `=!=${ Random.id() }=!=`;\n\n\t\t\t\t\tmessage.tokens.push({\n\t\t\t\t\t\thighlight: true,\n\t\t\t\t\t\ttoken,\n\t\t\t\t\t\ttext: `<pre><code class='code-colors hljs ${ result.language }'><span class='copyonly'>\\`\\`\\`<br></span>${ result.value }<span class='copyonly'><br>\\`\\`\\`</span></code></pre>`,\n\t\t\t\t\t\tnoHtml: `\\`\\`\\`\\n${ s.stripTags(result.value) }\\n\\`\\`\\``\n\t\t\t\t\t});\n\n\t\t\t\t\tmsgParts[index] = token;\n\t\t\t\t} else {\n\t\t\t\t\tmsgParts[index] = part;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Re-mount message\n\t\t\treturn message.html = msgParts.join('');\n\t\t}\n\t}\n}\n\nRocketChat.MarkdownCode = MarkdownCode;\n\nconst MarkdownCodeCB = (message) => new MarkdownCode(message);\n\n// MarkdownCode gets higher priority over Markdown so it's possible place a callback in between (katex for exmaple)\nRocketChat.callbacks.add('renderMessage', MarkdownCodeCB, RocketChat.callbacks.priority.HIGH - 2, 'markdowncode');\n"]}